plugins {
    id 'java'
    id 'idea'
    id 'io.quarkus' version "${quarkusPluginVersion}"
}

afterEvaluate {
    def isNative = System.getProperty('quarkus.native.enabled') == 'true'

    println "ğŸ”¨ Build Mode: ${isNative ? 'NATIVE BINARY' : 'JAR'}"
    if (isNative) {
        println "ğŸ“¦ Output: ${rootProject.name}-${version}-runner"
        println "ğŸš€ Native Build Config: Enabled=${System.getProperty('quarkus.native.enabled')}, Container=${System.getProperty('quarkus.native.container-build')}, Remote=${System.getProperty('quarkus.native.remote-container-build')}, BuilderImage=${System.getProperty('quarkus.native.builder-image')}"
    } else {
        println "ğŸ“¦ Output: ${rootProject.name}-${version}.jar"
    }
}

group = 'org.example'
version = '0.1.0-SNAPSHOT'

repositories {
    mavenCentral()
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

// Get all source files from this project and bundle them up in
// *-sources.jar
tasks.register('sourceJar', Jar) {
    from sourceSets.main.allJava
    archiveClassifier = 'sources'
}

idea {
    module {
        downloadJavadoc = true
    }
}

dependencies {
    implementation enforcedPlatform("${quarkusPlatformGroupId}:${quarkusPlatformArtifactId}:${quarkusPlatformVersion}")
    implementation 'io.quarkus:quarkus-resteasy-reactive'
    implementation 'io.quarkus:quarkus-arc'

    // Native image support
    implementation 'io.quarkus:quarkus-container-image-docker'

    testImplementation 'io.quarkus:quarkus-junit5'
    testImplementation 'io.rest-assured:rest-assured'
}

tasks.named('quarkusBuild') {
    doFirst {
        println "ğŸ”¥ Starting Quarkus Native Build for ${rootProject.name}-${version}-runner"
        println "âš™ï¸  Java Version: ${System.getProperty('java.version')}"
        println "âš™ï¸  GraalVM Home: ${System.getProperty('java.home')}"
        println "âš™ï¸  Memory Config: ${project.findProperty('quarkus.native.native-image-xmx')}"
    }
}

// Custom task to display build settings
task displayBuildSettings {
    doLast {
        println """
        =========================================================
        QUARKUS NATIVE BUILD CONFIGURATION
        =========================================================
        âš™ï¸  Quarkus Version: ${quarkusPlatformVersion}
        âš™ï¸  Java Version: ${java.sourceCompatibility}
        âš™ï¸  Native Image: ${System.getProperty('quarkus.native.enabled')}
        âš™ï¸  Container Build: ${System.getProperty('quarkus.native.container-build')}

        ğŸ“¦  Build Output: ${rootProject.name}-${version}.jar

        This build will produce:
        - Native executable for your current platform
        - hello world: curl localhost:8080/hello

        For cross-platform builds (Raspberry Pi), you'll need to:
        - Set appropriate GraalVM for the target platform
        - Configure additional build arguments as needed
        =========================================================
        """
    }
}

// Hook the display task to the build process
build.dependsOn displayBuildSettings
